<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resonance | D128 ST3AM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        
        /* The UI Overlay */
        #ui-layer {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px;
            pointer-events: none; /* Let clicks pass through to canvas if needed */
        }
        
        button {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #fff;
            color: #fff;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        button:hover { background: rgba(255, 255, 255, 0.3); }

        /* Start Screen */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.9); color: white; cursor: pointer; z-index: 10;
        }
        h1 { font-size: 3rem; margin-bottom: 0.5rem; text-shadow: 0 0 10px #fff; }
        p { color: #aaa; }
    </style>
</head>
<body>

    <div id="overlay" onclick="startApp()">
        <h1>RESONANCE</h1>
        <p>[ CLICK TO INITIALIZE SENSORS ]</p>
    </div>

    <div id="ui-layer" style="display:none;">
        <button onclick="togglePause()">Freeze / Resume</button>
        <button onclick="saveArt()">Export .JPG</button>
    </div>

    <script>
        let mic, fft;
        let isStarted = false;
        let isPaused = false;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            angleMode(DEGREES); // Easier to understand math
            background(0);
        }

        function startApp() {
            mic = new p5.AudioIn();
            mic.start();
            fft = new p5.FFT(0.8, 64); // Smoothing 0.8, 64 Frequency Bins
            fft.setInput(mic);
            
            isStarted = true;
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
        }

        function draw() {
            if (!isStarted || isPaused) return;

            // Fades the previous frame slightly to create "trails" rather than clearing screen
            background(0, 0, 0, 10); 

            let spectrum = fft.analyze(); 
            translate(width / 2, height / 2);

            // Create circular symmetry
            beginShape();
            for (let i = 0; i < spectrum.length; i++) {
                let amp = spectrum[i];
                let angle = map(i, 0, spectrum.length, 0, 360);
                
                // MATH: Mapping Volume to Radius
                // If quiet, radius is small. If loud, radius expands.
                let r = map(amp, 0, 255, 100, 400); 

                // MATH: Mapping Pitch to Color (0-255)
                // Low Bass = Red/Orange, High Treble = Blue/Purple
                let colorCode = map(i, 0, spectrum.length, 0, 255);
                
                stroke(colorCode, 255, 255);
                strokeWeight(2);
                colorMode(HSB); 
                noFill();

                // Convert Polar to Cartesian coordinates
                let x = r * cos(angle);
                let y = r * sin(angle);
                
                // Add some "jitter" based on volume for energy effect
                if (amp > 200) { 
                    x += random(-5, 5); 
                    y += random(-5, 5);
                }

                vertex(x, y);
            }
            endShape(CLOSE);
            
            // Mirror the shape for symmetry
            beginShape();
            for (let i = 0; i < spectrum.length; i++) {
                let amp = spectrum[i];
                let angle = map(i, 0, spectrum.length, 0, 360);
                let r = map(amp, 0, 255, 100, 400); 
                let x = r * cos(angle);
                let y = r * sin(angle);
                vertex(-x, -y); // Mirror coordinates
            }
            endShape(CLOSE);
        }

        function togglePause() {
            isPaused = !isPaused;
        }

        function saveArt() {
            saveCanvas('My_Sonic_Sculpture', 'jpg');
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            background(0);
        }
    </script>
</body>
</html>
